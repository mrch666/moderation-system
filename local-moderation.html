<!DOCTYPE html>
<html>
<head>
    <title>üöÄ –°–∏—Å—Ç–µ–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ - –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; border: none; border-radius: 3px; }
        .btn-approve { background: #2ecc71; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-refresh { background: #3498db; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { color: #666; font-style: italic; }
        img { max-width: 200px; max-height: 150px; margin-right: 15px; float: left; }
        .clear { clear: both; }
    </style>
</head>
<body>
    <h1>üöÄ –°–∏—Å—Ç–µ–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
    <p><strong>–õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</strong> - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞</p>
    
    <div>
        <button class="btn-refresh" onclick="loadQueue()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</button>
        <button onclick="createTest()">üß™ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>
        <button onclick="checkBackend()">üîß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
    </div>
    
    <div id="status" class="status loading">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
    
    <div id="queue">
        <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p>
    </div>
    
    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
        <ol>
            <li>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω: <code>http://localhost:3000</code></li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API"</li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å"</li>
            <li>–ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ "–û–¥–æ–±—Ä–∏—Ç—å" –∏–ª–∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"</li>
        </ol>
        <p><strong>Backend API:</strong> <code>http://localhost:3000</code></p>
        <p><strong>API –∫–ª—é—á:</strong> <code>test_api_key_123456</code></p>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const API_URL = 'http://localhost:3000/api';
        const API_KEY = 'test_api_key_123456';
        
        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
        }
        
        // ========== API –§–£–ù–ö–¶–ò–ò ==========
        async function makeRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'X-API-Key': API_KEY,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) options.body = JSON.stringify(data);
            
            try {
                const response = await fetch(API_URL + endpoint, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                return await response.json();
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('API Error:', error);
                return null;
            }
        }
        
        // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        async function checkBackend() {
            showStatus('–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...');
            try {
                const response = await fetch(API_URL + '/health');
                const data = await response.json();
                showStatus(`‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç: ${data.service} v${data.version}`, 'success');
                return true;
            } catch (error) {
                showStatus(`‚ùå Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function loadQueue() {
            showStatus('–ó–∞–≥—Ä—É–∂–∞—é –æ—á–µ—Ä–µ–¥—å...');
            
            const result = await makeRequest('/moderation/queue?limit=10');
            if (!result || !result.success) return;
            
            const queueDiv = document.getElementById('queue');
            
            if (!result.data || result.data.length === 0) {
                queueDiv.innerHTML = '<p>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</p>';
                showStatus(`‚úÖ –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞`, 'success');
                return;
            }
            
            let html = `<h3>üìã –û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (${result.pagination.total} —ç–ª–µ–º–µ–Ω—Ç–æ–≤):</h3>`;
            
            result.data.forEach(item => {
                const metadata = typeof item.metadata === 'string' ? 
                    JSON.parse(item.metadata) : (item.metadata || {});
                
                html += `
                <div class="item">
                    <img src="${item.image_url}" 
                         onerror="this.style.display='none'"
                         alt="${metadata.title || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'}">
                    <div>
                        <h4>${metadata.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h4>
                        <p><strong>ID —Ç–æ–≤–∞—Ä–∞:</strong> ${item.product_id}</p>
                        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${metadata.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p><strong>–¶–µ–Ω–∞:</strong> ${metadata.price || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${item.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : item.status}</p>
                        <p><strong>UUID:</strong> ${item.moderation_uuid}</p>
                        <button class="btn-approve" onclick="moderate('${item.moderation_uuid}', 'approved')">
                            ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                        </button>
                        <button class="btn-reject" onclick="moderate('${item.moderation_uuid}', 'rejected')">
                            ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                    <div class="clear"></div>
                </div>`;
            });
            
            queueDiv.innerHTML = html;
            showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.data.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, 'success');
        }
        
        async function moderate(id, status) {
            if (status === 'approved') {
                if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –º–æ–¥–µ—Ä–∞—Ü–∏—é?\n\n1. –í—Å–µ —Ç–æ–≤–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ ID –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏\n2. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä img.instrumentstore.ru:7990')) {
                    return;
                }
            }
            
            showStatus(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω–∏–µ' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ'}...`);
            
            const result = await makeRequest(`/moderation/${id}/moderate`, 'PUT', { status });
            if (result && result.success) {
                let message = status === 'approved' ? '‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∞' : '‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞';
                if (result.data.upload && result.data.upload.success) {
                    message += `\nüìÅ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${result.data.upload.filename}`;
                }
                showStatus(message, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(loadQueue, 1000);
            }
        }
        
        async function createTest() {
            const testData = {
                product_id: `TEST_${Date.now()}`,
                image_url: 'https://example.com/test.jpg',
                download_url: 'https://example.com/test.jpg',
                metadata: {
                    title: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
                    description: '–°–æ–∑–¥–∞–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã',
                    price: '1000 —Ä—É–±',
                    category: '–¢–µ—Å—Ç'
                }
            };
            
            showStatus('–°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é...');
            
            const result = await makeRequest('/moderation/submit', 'POST', testData);
            if (result && result.success) {
                showStatus(`‚úÖ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω! ID: ${result.data.moderation_id}`, 'success');
                setTimeout(loadQueue, 1000);
            }
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('API URL:', API_URL);
            console.log('API Key:', API_KEY);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º backend
            checkBackend();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å:', e.target.src);
                e.target.style.display = 'none';
            }
        }, true);
    </script>
</body>
</html>