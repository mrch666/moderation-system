<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –†–ï–ê–õ–¨–ù–û–ô –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç –†–ï–ê–õ–¨–ù–û–ô –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h1>
    
    <div class="status info" id="status1">
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ backend...
    </div>
    
    <div class="status info" id="status2">
        –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞...
    </div>
    
    <div class="status info" id="status3">
        –û–¥–æ–±—Ä–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∑–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ)...
    </div>
    
    <div class="status info" id="status4">
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...
    </div>
    
    <div class="log" id="log"></div>
    
    <button onclick="runFullTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
    <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    
    <script>
        const API_URL = 'http://192.168.1.189:3000/api';
        const logElement = document.getElementById('log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function clearLog() {
            logElement.textContent = '';
        }
        
        function updateStatus(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = 'status ' + type;
        }
        
        async function runFullTest() {
            clearLog();
            log('=== –ù–ê–ß–ê–õ–û –¢–ï–°–¢–ê –†–ï–ê–õ–¨–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û ===');
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ backend
            updateStatus('status1', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ backend...', 'info');
            try {
                const healthResponse = await fetch('http://192.168.1.189:3000/health');
                if (healthResponse.ok) {
                    const data = await healthResponse.json();
                    updateStatus('status1', `‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç: ${data.service}`, 'success');
                    log(`Backend: ${JSON.stringify(data)}`);
                } else {
                    updateStatus('status1', '‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç', 'error');
                    return;
                }
            } catch (error) {
                updateStatus('status1', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                return;
            }
            
            // 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            updateStatus('status2', '–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞...', 'info');
            const productId = 'PHOTO-UPLOAD-TEST-' + Date.now();
            
            try {
                const submitResponse = await fetch(`${API_URL}/moderation/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_url: 'https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=800&h=600',
                        product_id: productId,
                        download_url: 'https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=800&h=600',
                        metadata: { name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ' }
                    })
                });
                
                const submitData = await submitResponse.json();
                
                if (submitData.success) {
                    const itemId = submitData.data.moderation_id;
                    updateStatus('status2', `‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω: ${productId} (ID: ${itemId})`, 'success');
                    log(`–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω: ${JSON.stringify(submitData.data)}`);
                    
                    // 3. –û–¥–æ–±—Ä–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                    updateStatus('status3', '–û–¥–æ–±—Ä–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∑–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ)...', 'info');
                    
                    setTimeout(async () => {
                        try {
                            const moderateResponse = await fetch(`${API_URL}/moderation/${itemId}/moderate`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: 'approved' })
                            });
                            
                            const moderateData = await moderateResponse.json();
                            
                            if (moderateData.success) {
                                updateStatus('status3', `‚úÖ –¢–æ–≤–∞—Ä –æ–¥–æ–±—Ä–µ–Ω! –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∑–∞–ø—É—â–µ–Ω–∞`, 'success');
                                log(`–ú–æ–¥–µ—Ä–∞—Ü–∏—è: ${JSON.stringify(moderateData.data)}`);
                                
                                // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                                updateStatus('status4', '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ù–ê–ß–ê–¢–ê!', 'success');
                                log('=== –í–ê–ñ–ù–û ===');
                                log('1. Backend –ø–æ–ª—É—á–∏–ª –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ');
                                log('2. –í –∫–æ–Ω—Å–æ–ª–∏ backend –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:');
                                log('   - üöÄ REAL: Starting photo upload for...');
                                log('   - üì§ REAL: Uploading photo for...');
                                log('   - üì§ ModelID: ..., URL: ...');
                                log('   - ‚úÖ REAL: Target server response: ...');
                                log('3. –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞: http://img.instrumentstore.ru:7990/api/modelgoods/image/');
                                log('4. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç 200/201 - —Ñ–æ—Ç–æ –ó–ê–ì–†–£–ñ–ï–ù–û!');
                                log('5. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ - —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ç—Å—é–¥–∞');
                                log('');
                                log('üéØ –†–ï–ó–£–õ–¨–¢–ê–¢: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –†–ê–ë–û–¢–ê–ï–¢!');
                                log('   –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏.');
                                
                            } else {
                                updateStatus('status3', `‚ùå –û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: ${moderateData.error}`, 'error');
                            }
                        } catch (error) {
                            updateStatus('status3', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                        }
                    }, 1000);
                    
                } else {
                    updateStatus('status2', `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ${submitData.error}`, 'error');
                }
            } catch (error) {
                updateStatus('status2', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
        setTimeout(() => {
            log('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç—É. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç"');
        }, 1000);
    </script>
</body>
</html>