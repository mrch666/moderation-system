#!/bin/bash

echo "üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏"
echo "========================================"

API_URL="http://localhost:3000/api"
API_KEY="test_api_key_123456"

echo ""
echo "1. –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–º —Ñ–∞–π–ª–æ–º:"
echo "   (–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å picsum.photos)"

WORKING_ITEM='{
    "image_url": "https://picsum.photos/800/600",
    "product_id": "WORKING-FILE-TEST",
    "download_url": "https://picsum.photos/800/600",
    "metadata": {
        "name": "–¢–æ–≤–∞—Ä —Å —Ä–∞–±–æ—Ç–∞—é—â–∏–º —Ñ–∞–π–ª–æ–º –¥–ª—è —Ç–µ—Å—Ç–∞",
        "category": "—Ä–∞–±–æ—á–∏–π-—Ç–µ—Å—Ç",
        "note": "–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞—Ç—å—Å—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è"
    }
}'

RESPONSE=$(curl -s -X POST "$API_URL/moderation/submit" \
    -H "X-API-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$WORKING_ITEM")

if echo "$RESPONSE" | grep -q "success"; then
    ITEM_ID=$(echo "$RESPONSE" | grep -o '"moderation_id":"[^"]*"' | cut -d'"' -f4)
    echo "   ‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω, UUID: $ITEM_ID"
    
    # –ù–∞—Ö–æ–¥–∏–º —á–∏—Å–ª–æ–≤–æ–π ID
    NUMERIC_ID=$(curl -s -H "X-API-Key: $API_KEY" "$API_URL/moderation/queue" | \
      python3 -c "
import json, sys
try:
    data = json.loads(sys.stdin.read())
    for item in data.get('data', []):
        if item.get('product_id') == 'WORKING-FILE-TEST':
            print(item['id'])
            break
except:
    print('')
" 2>/dev/null)
    
    if [ -n "$NUMERIC_ID" ]; then
        echo "   üî¢ –ß–∏—Å–ª–æ–≤–æ–π ID –¥–ª—è —Ç–µ—Å—Ç–∞: $NUMERIC_ID"
        
        echo ""
        echo "2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –ª–æ–≥–æ–≤:"
        echo "   –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "   cd moderation-system && tail -f backend/backend.log"
        echo ""
        echo "3. –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –æ–¥–æ–±—Ä–µ–Ω–∏—è:"
        echo ""
        echo "   curl -X PUT $API_URL/moderation/$NUMERIC_ID/moderate \\"
        echo "        -H 'X-API-Key: $API_KEY' \\"
        echo "        -H 'Content-Type: application/json' \\"
        echo "        -d '{\"status\": \"approved\", \"reason\": \"–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Ñ–∞–π–ª–∞\"}'"
        echo ""
        echo "4. –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ª–æ–≥–∞—Ö:"
        echo "   üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ WORKING-FILE-TEST..."
        echo "   –ò—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞: https://picsum.photos/800/600"
        echo "   üì• –§–∞–π–ª —Å–∫–∞—á–∞–Ω: ... bytes, image/jpeg"
        echo "   üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä..."
        echo "   üì® –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: 500 (–æ–∂–∏–¥–∞–µ—Ç—Å—è, —Ç.–∫. —Å–µ—Ä–≤–µ—Ä —Ç–µ—Å—Ç–æ–≤—ã–π)"
        echo "   üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏: { detail: 'Internal server error' }"
        echo ""
        echo "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:"
        echo "   üåê –û—Ç–∫—Ä–æ–π—Ç–µ: http://192.168.1.189:8080"
        echo "   üìã –ù–∞–π–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä 'WORKING-FILE-TEST'"
        echo "   ‚úÖ –ù–∞–∂–º–∏—Ç–µ '–û–¥–æ–±—Ä–∏—Ç—å'"
        echo "   üìù –£–≤–∏–¥–∏—Ç–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞ img.instrumentstore.ru:7990"
        
    else
        echo "   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ–≤–æ–π ID —Ç–æ–≤–∞—Ä–∞"
    fi
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"
    echo "$RESPONSE"
fi

echo ""
echo "üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:"
echo ""
echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢:"
echo "   1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å download_url"
echo "   2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (200 OK)"
echo "   3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (404, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏)"
echo "   4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ FormData —Å modelid –∏ file"
echo "   5. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä :7990"
echo "   6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
echo "   7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞"
echo "   8. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –æ—Ç–≤–µ—Ç–µ API"
echo "   9. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"
echo ""
echo "‚ö†Ô∏è –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø (–æ–∂–∏–¥–∞–µ–º—ã–µ):"
echo "   1. –¶–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 –æ—à–∏–±–∫—É (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)"
echo "   2. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
echo "   3. –¢–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö"
echo ""
echo "üîß –ì–û–¢–û–í–ù–û–°–¢–¨ –ö PRODUCTION:"
echo "   –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "   1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ"
echo "   2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ source —Å–µ—Ä–≤–µ—Ä–µ"
echo "   3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry –ª–æ–≥–∏–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö"
echo "   4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥"
