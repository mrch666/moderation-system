            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${apiUrl}${endpoint}`, options);
                
                if (response.status === 401) {
                    showAlert('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á.', 'error');
                    return null;
                }
                
                if (response.status === 403) {
                    showAlert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.', 'error');
                    return null;
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    showAlert(`–û—à–∏–±–∫–∞: ${error.error || response.statusText}`, 'error');
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function loadStats() {
            showLoading('dashboard');
            
            const stats = await makeRequest('/moderation/stats');
            const queue = await makeRequest('/moderation/queue?limit=1');
            
            if (stats && queue) {
                const statsGrid = document.getElementById('stats-grid');
                
                // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const approved = stats.data?.find(s => s.status === 'approved')?.count || 0;
                const rejected = stats.data?.find(s => s.status === 'rejected')?.count || 0;
                const pending = queue.data?.length || 0;
                const total = approved + rejected + pending;
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –º–æ–¥–µ—Ä–∞—Ü–∏–π</div>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
                        <div class="stat-value" style="color: #48bb78;">${approved}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                        <div class="stat-value" style="color: #f56565;">${rejected}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í –æ—á–µ—Ä–µ–¥–∏</div>
                        <div class="stat-value" style="color: #ed8936;">${pending}</div>
                    </div>
                `;
            }
            
            hideLoading('dashboard');
        }
        
        async function refreshQueue() {
            showLoading('queue');
            
            const queue = await makeRequest('/moderation/queue?limit=20');
            
            if (queue) {
                const container = document.getElementById('queue-table-container');
                
                if (queue.data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #718096;">–û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø—É—Å—Ç–∞</p>';
                    hideLoading('queue');
                    return;
                }
                
                let tableHTML = `
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                queue.data.forEach(item => {
                    const date = new Date(item.submitted_at).toLocaleString('ru-RU');
                    const statusClass = `status-${item.status}`;
                    const statusText = {
                        'pending': '–í –æ–∂–∏–¥–∞–Ω–∏–∏',
                        'approved': '–û–¥–æ–±—Ä–µ–Ω–æ',
                        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                        'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
                    }[item.status] || item.status;
                    
                    tableHTML += `
                        <tr>
                            <td>${item.id}</td>
                            <td><strong>${item.product_id}</strong></td>
                            <td>
                                <a href="${item.image_url}" target="_blank" style="color: #667eea; text-decoration: none;">
                                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </a>
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${date}</td>
                            <td>
                                <div class="action-buttons">
                                    ${item.status === 'pending' ? `
                                        <button onclick="moderate(${item.id}, 'approved')" class="btn btn-sm btn-success">‚úÖ</button>
                                        <button onclick="moderate(${item.id}, 'rejected')" class="btn btn-sm btn-danger">‚ùå</button>
                                    ` : ''}
                                    <button onclick="viewDetails(${item.id})" class="btn btn-sm">üëÅÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            }
            
            hideLoading('queue');
        }
        
        async function moderate(id, status) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${status === 'approved' ? '–æ–¥–æ–±—Ä–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å'} —ç—Ç—É –º–æ–¥–µ—Ä–∞—Ü–∏—é?`)) {
                return;
            }
            
            const result = await makeRequest(`/moderation/${id}/moderate`, 'PUT', {
                status: status
            });
            
            if (result) {
                showAlert(`–ú–æ–¥–µ—Ä–∞—Ü–∏—è #${id} ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`, 'success');
                refreshQueue();
                loadStats();
            }
        }
        
        async function viewDetails(id) {
            const result = await makeRequest(`/moderation/${id}/logs`);
            
            if (result) {
                const logs = result.data || [];
                let logText = '–õ–æ–≥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏:\n\n';
                
                logs.forEach(log => {
                    const date = new Date(log.created_at).toLocaleString('ru-RU');
                    logText += `${date} - ${log.action} (${log.username || '—Å–∏—Å—Ç–µ–º–∞'})\n`;
                });
                
                alert(logText);
            }
        }
        
        async function submitModeration(event) {
            event.preventDefault();
            
            const imageUrl = document.getElementById('imageUrl').value;
            const productId = document.getElementById('productId').value;
            const downloadUrl = document.getElementById('downloadUrl').value;
            const metadataText = document.getElementById('metadata').value;
            
            let metadata = {};
            if (metadataText) {
                try {
                    metadata = JSON.parse(metadataText);
                } catch (e) {
                    showAlert('–û—à–∏–±–∫–∞ –≤ JSON –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö', 'error');
                    return;
                }
            }
            
            const data = {
                image_url: imageUrl,
                product_id: productId,
                download_url: downloadUrl,
                metadata: metadata
            };
            
            const result = await makeRequest('/moderation/submit', 'POST', data);
            
            if (result) {
                const resultDiv = document.getElementById('submit-result');
                const output = document.getElementById('result-output');
                
                output.textContent = JSON.stringify(result, null, 2);
                resultDiv.style.display = 'block';
                
                showAlert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!', 'success');
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –æ—á–µ—Ä–µ–¥—å
                loadStats();
                refreshQueue();
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        async function testConnection() {
            const result = await makeRequest('/health');
            
            if (result) {
                showAlert('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API —É—Å–ø–µ—à–Ω–æ!', 'success');
            }
        }
        
        async function testApi() {
            const apiUrl = document.getElementById('apiUrl').value;
            
            if (!apiUrl) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ URL API', 'error');
                return;
            }
            
            localStorage.setItem(API_URL_KEY, apiUrl);
            
            try {
                const response = await fetch(apiUrl.replace('/api', '') + '/health');
                const result = await response.json();
                
                const testResult = document.getElementById('api-test-result');
                testResult.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω!</strong><br>
                        –°—Ç–∞—Ç—É—Å: ${result.status}<br>
                        –í—Ä–µ–º—è: ${new Date(result.timestamp).toLocaleString('ru-RU')}
                    </div>
                `;
            } catch (error) {
                const testResult = document.getElementById('api-test-result');
                testResult.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        function clearSettings() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?')) {
                localStorage.removeItem(API_BASE_KEY);
                localStorage.removeItem(API_URL_KEY);
                loadSettings();
                showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—â–µ–Ω—ã', 'success');
            }
        }
    </script>
</body>
</html>